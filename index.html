<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JokeBot: My AI Comedy Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            background-image:
                radial-gradient(circle at 50% 0, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 40%),
                radial-gradient(circle at 10% 20%, rgba(255, 165, 0, 0.1) 0%, rgba(255, 165, 0, 0) 30%),
                radial-gradient(circle at 90% 80%, rgba(70, 0, 130, 0.1) 0%, rgba(70, 0, 130, 0) 30%);
            color: #f0f0f0;
        }

        .font-bangers {
            font-family: 'Bangers', cursive;
        }

        .neon-text {
            text-shadow:
                0 0 5px #fff,
                0 0 10px #fff,
                0 0 20px #ff4da6,
                0 0 30px #ff4da6,
                0 0 40px #ff4da6,
                0 0 55px #ff4da6,
                0 0 75px #ff4da6;
        }
        
        .joke-card {
            background: rgba(40, 40, 40, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .form-input, .form-select {
            background-color: rgba(20, 20, 20, 0.8);
            border: 1px solid #4a4a4a;
            color: #f0f0f0;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            background-color: rgba(10, 10, 10, 0.9);
            border-color: #ff4da6;
            box-shadow: 0 0 10px rgba(255, 77, 166, 0.5);
            outline: none;
        }
        
        .btn-generate {
            background: linear-gradient(45deg, #ff4da6, #ff70b8);
            box-shadow: 0 4px 15px rgba(255, 77, 166, 0.4);
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 77, 166, 0.6);
        }
        
        .loader {
            width: 50px;
            height: 50px;
            position: relative;
        }
        .mic-icon {
            font-size: 50px;
            color: #ff4da6;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="font-bangers text-6xl md:text-8xl neon-text">JokeBot</h1>
            <p class="text-lg text-gray-400">My Project in AI-Driven Comedy</p>
        </header>

        <main class="space-y-8">
            <!-- Configuration Section -->
            <section id="config-section" class="joke-card rounded-xl p-6 shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">Your OpenRouter API Key</label>
                        <input type="password" id="apiKey" class="form-input w-full rounded-md p-2" placeholder="sk-or-v1-...">
                    </div>
                    <div class="flex items-end">
                        <button id="toggle-how-it-works" class="w-full text-sm bg-gray-600 hover:bg-gray-500 transition-colors text-white py-2 px-4 rounded-md">
                            Show How It Works
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label for="generatorModel" class="block text-sm font-medium text-gray-300 mb-1">Joke Generator Model</label>
                        <select id="generatorModel" class="form-select w-full rounded-md p-2">
                             <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                            <option value="nousresearch/nous-hermes-2-mixtral-8x7b-dpo">Nous Hermes 2 Mixtral (Free)</option>
                            <option value="google/gemma-7b-it:free">Google Gemma 7B (Free)</option>
                            <option value="openai/gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    <div>
                        <label for="judgeModel" class="block text-sm font-medium text-gray-300 mb-1">Joke Judge Model</label>
                        <select id="judgeModel" class="form-select w-full rounded-md p-2">
                           <option value="nousresearch/nous-hermes-2-mixtral-8x7b-dpo">Nous Hermes 2 Mixtral (Free)</option>
                           <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                            <option value="google/gemma-7b-it:free">Google Gemma 7B (Free)</option>
                            <option value="openai/gpt-4">OpenAI GPT-4</option>
                        </select>
                    </div>
                </div>
            </section>
            
            <!-- "How It Works" Section (Initially Hidden) -->
            <section id="how-it-works" class="hidden joke-card rounded-xl p-6 shadow-lg space-y-4 text-gray-300">
                <h2 class="text-2xl font-bold text-white">How I Built This: The Comedy Pipeline</h2>
                <p>Instead of just asking an AI for a joke, I built a system inspired by the paper <a href="https://arxiv.org/pdf/2409.03733" target="_blank" class="text-pink-400 hover:underline">"Planning In Natural Language Improves LLM Search For Code Generation"</a>. The paper's core idea, which I've adapted, is called PLANSEARCH. This pipeline forces the AI to be more creative and less repetitive.</p>
                
                <div class="space-y-2">
                    <h3 class="font-semibold text-lg text-pink-300">My Joke Generation Pipeline:</h3>
                    <ol class="list-decimal list-inside space-y-1">
                        <li><strong>1. Brainstorm Angles:</strong> I give the AI a topic (like "penguins") and have it come up with funny observations, like "they wear tuxedos" or "they waddle."</li>
                        <li><strong>2. Create Setups (The Plan):</strong> For each angle, the AI creates a joke setup. This is the "plan" for the joke.</li>
                        <li><strong>3. Write Punchlines (The Execution):</strong> With a setup ready, the AI generates a few punchlines to finish the job.</li>
                        <li><strong>4. Hire an AI Judge:</strong> I show all the jokes (in random order, to be fair) to a *second* AI. It rates each one from 1 to 10 for funniness.</li>
                        <li><strong>5. Find the Headliner:</strong> My app then shows you the top-rated jokes from the judge!</li>
                    </ol>
                </div>

                <div class="space-y-2 pt-4 border-t border-gray-600">
                    <h3 class="font-semibold text-lg text-pink-300">My Thoughts on Novelty &amp; AI</h3>
                    <p><strong class="text-white">What makes a joke novel?</strong> It's not just about being new. A novel joke makes a surprising and clever connection that you didn't see coming.</p>
                    <p><strong class="text-white">How I'd test for novelty:</strong> This is tricky! I'd use a few methods:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>The Google Test:</strong> I'd search for the joke online. If it's everywhere, it's not novel.</li>
                        <li><strong>Semantic Search:</strong> I'd check the joke against a huge database of other jokes to see if it's just a re-worded copy.</li>
                    </ul>
                    <p><strong class="text-white">How this pipeline fights memorization:</strong> By breaking the process into `Angle -> Setup -> Punchline`, I force the AI to *build* a joke from ideas, not just recall a finished one. It's about creativity, not memory.</p>
                </div>
            </section>

            <!-- Joke Generation Section -->
            <section id="joke-generator-section" class="text-center">
                 <div class="relative inline-block w-full max-w-lg">
                    <input type="text" id="jokeTopic" class="form-input w-full rounded-full p-4 pl-6 pr-40 text-lg" placeholder="Give me a topic (e.g., cats, programming)...">
                    <button id="generateBtn" class="btn-generate absolute top-1/2 right-2 transform -translate-y-1/2 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 ease-in-out">
                        Tell Me a Joke!
                    </button>
                </div>
            </section>
            
            <!-- Status and Results Section -->
            <section id="results-section" class="mt-8 min-h-[300px]">
                <div id="loader" class="hidden justify-center items-center flex-col">
                    <div class="loader">
                         <svg xmlns="http://www.w3.org/2000/svg" class="mic-icon" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                            <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                         </svg>
                    </div>
                    <p id="statusText" class="text-center mt-4 text-gray-400"></p>
                </div>
                <div id="jokes-output" class="space-y-4">
                    <!-- Jokes will be injected here -->
                </div>
                 <div id="error-output" class="hidden text-center text-red-400 bg-red-900/50 p-4 rounded-lg"></div>
            </section>
        </main>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const jokeTopicInput = document.getElementById('jokeTopic');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('statusText');
        const jokesOutput = document.getElementById('jokes-output');
        const errorOutput = document.getElementById('error-output');
        const apiKeyInput = document.getElementById('apiKey');
        const generatorModelSelect = document.getElementById('generatorModel');
        const judgeModelSelect = document.getElementById('judgeModel');
        const toggleHowItWorksBtn = document.getElementById('toggle-how-it-works');
        const howItWorksSection = document.getElementById('how-it-works');

        // --- Event Listeners ---
        
        toggleHowItWorksBtn.addEventListener('click', () => {
            const isHidden = howItWorksSection.classList.contains('hidden');
            howItWorksSection.classList.toggle('hidden');
            toggleHowItWorksBtn.textContent = isHidden ? 'Hide How It Works' : 'Show How It Works';
        });

        generateBtn.addEventListener('click', generateJokesPipeline);
        jokeTopicInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateJokesPipeline();
            }
        });

        // --- API Call Helper ---

        async function makeApiCall(prompt, model, isJson = false) {
            const apiKey = apiKeyInput.value;
            if (!apiKey) {
                throw new Error("Please enter your OpenRouter API Key.");
            }

            const headers = {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json",
            };
            
            const body = {
                model: model,
                messages: [{ role: "user", content: prompt }],
            };
            
            if(isJson){
                body.response_format = { "type": "json_object" };
            }

            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: headers,
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error:", errorData);
                throw new Error(`API call failed for model ${model}: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // --- My Joke Generation Pipeline ---

        async function generateJokesPipeline() {
            const topic = jokeTopicInput.value.trim();
            if (!topic) {
                showError("Please enter a topic for the joke.");
                return;
            }

            clearOutput();
            showLoader(true);
            
            const generatorModel = generatorModelSelect.value;
            const judgeModel = judgeModelSelect.value;

            try {
                // Step 1: Generate diverse angles
                updateStatus("Step 1: Brainstorming funny angles...");
                const anglesPrompt = `Generate 4 diverse and distinct angles or observations about the topic "${topic}". These should be short, creative starting points for jokes. Output them as a simple list separated by newlines.`;
                const anglesResponse = await makeApiCall(anglesPrompt, generatorModel);
                const angles = anglesResponse.split('\n').map(a => a.trim()).filter(a => a);

                // Step 2 & 3: Generate setups and punchlines for each angle
                updateStatus("Step 2 & 3: Turning angles into jokes...");
                let allJokes = [];
                const jokePromises = angles.map(async (angle) => {
                    const setupPunchlinePrompt = `Based on the angle "${angle}" about "${topic}", create a complete joke with a setup and a punchline. Format the output as a JSON object with two keys: "setup" and "punchline".`;
                    const jokeJsonString = await makeApiCall(setupPunchlinePrompt, generatorModel, true);
                    try {
                        const joke = JSON.parse(jokeJsonString);
                        if (joke.setup && joke.punchline) {
                           return joke;
                        }
                    } catch(e) {
                        console.error("Failed to parse joke JSON:", jokeJsonString);
                        return null; // Skip malformed jokes
                    }
                });
                
                const generatedJokes = (await Promise.all(jokePromises)).filter(j => j);
                if (generatedJokes.length === 0) {
                   throw new Error("The generator model failed to create any valid jokes. Try a different model or topic.");
                }


                // Step 4: LLM-as-a-Judge
                updateStatus("Step 4: Asking the AI comedy critic for ratings...");
                const shuffledJokes = generatedJokes.sort(() => Math.random() - 0.5);
                const judgePrompt = `You are a comedy critic. I will give you a list of jokes. Your task is to rate each joke for its funniness on a scale from 1 (not funny at all) to 10 (hilarious). Also provide a very brief one-sentence justification for your rating. 
                
                The topic is "${topic}".
                
                Here are the jokes:
                ${JSON.stringify(shuffledJokes, null, 2)}
                
                Please provide your response as a single JSON object. The object should have a key "ratings", which is an array. Each item in the array should be an object containing the original "setup", "punchline", and your added "rating" (as a number) and "justification" (as a string).`;
                
                const ratingsJsonString = await makeApiCall(judgePrompt, judgeModel, true);
                const ratingsResult = JSON.parse(ratingsJsonString);
                
                // Step 5: Display Results
                updateStatus("And the headliners are...");
                displayJokes(ratingsResult.ratings);

            } catch (error) {
                console.error("Pipeline Error:", error);
                showError(error.message);
            } finally {
                showLoader(false);
            }
        }

        // --- UI Update Functions ---
        
        function showLoader(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                loader.classList.add('flex');
            } else {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function updateStatus(text) {
            statusText.textContent = text;
        }

        function showError(message) {
            jokesOutput.innerHTML = '';
            errorOutput.textContent = `Whoops! The AI comedian slipped on a banana peel. (Error: ${message})`;
            errorOutput.classList.remove('hidden');
        }

        function clearOutput() {
            jokesOutput.innerHTML = '';
            errorOutput.classList.add('hidden');
            statusText.textContent = '';
        }
        
        function displayJokes(ratedJokes) {
            clearOutput();
            
            ratedJokes.sort((a, b) => (b.rating || 0) - (a.rating || 0));

            if (ratedJokes.length === 0) {
                jokesOutput.innerHTML = `<p class="text-center text-gray-400">The comedian is stumped! No jokes were generated.</p>`;
                return;
            }
            
            ratedJokes.forEach((joke, index) => {
                const jokeElement = document.createElement('div');
                jokeElement.className = 'joke-card rounded-xl p-5 shadow-lg fade-in';
                jokeElement.style.animationDelay = `${index * 150}ms`;
                
                const starRating = '⭐'.repeat(Math.round(joke.rating / 2)) + '✩'.repeat(5 - Math.round(joke.rating / 2));
                
                jokeElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="text-xl font-semibold text-white">${joke.setup}</p>
                        <div class="text-right ml-4 flex-shrink-0">
                           <span class="text-2xl font-bold text-pink-400">${joke.rating || 'N/A'}/10</span>
                           <div class="text-yellow-400 text-sm">${starRating}</div>
                        </div>
                    </div>
                    <p class="mt-2 text-lg text-gray-300">${joke.punchline}</p>
                    <p class="mt-4 text-xs text-gray-500 border-t border-gray-700 pt-2"><em>Judge's notes: "${joke.justification || 'No comment.'}"</em></p>
                `;
                jokesOutput.appendChild(jokeElement);
            });
        }
    </script>
</body>
</html>
